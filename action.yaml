name: "AccuKnox Container Scan"
description: "Run AccuKnox Container Security scan on a container image"

branding:
  icon: "shield"
  color: "purple"

inputs:
  accuknox_token:
    description: "The token for authenticating with the CSPM panel."
    required: true
  accuknox_label:
    description: "The label created in AccuKnox SaaS for associating scan results."
    required: true
  accuknox_endpoint:
    description: "The URL of the CSPM panel to push the scan results to."
    required: true
  image_name:
    description: "Docker image name to scan"
    required: true
  tag:
    description: "Docker image tag (optional)"
    required: false
    default: "latest"
  severity:
    description: "Comma-separated severities"
    required: false
    default: "UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL"
  soft_fail:
    description: "Do not fail pipeline on findings"
    required: false
    default: false
  generate_sbom:
    description: "Generate SBOM"
    required: false
    default: false
  project_name:
    description: "AccuKnox Project Name (required for SBOM)"
    required: false
    default: ""
  keep_results:
    description: "Upload scan results as artifacts"
    required: false
    default: false

runs:
  using: "composite"
  steps:
    - name: Run AccuKnox Container Scan
      shell: bash
      env:
        ACCUKNOX_TOKEN: ${{ inputs.accuknox_token }}
        ACCUKNOX_LABEL: ${{ inputs.accuknox_label }}
        ACCUKNOX_ENDPOINT: ${{ inputs.accuknox_endpoint }}
        IMAGE_NAME: ${{ inputs.image_name }}
        TAG: ${{ inputs.tag }}
        SEVERITY: ${{ inputs.severity }}
        SOFT_FAIL: ${{ inputs.soft_fail }}
        GENERATE_SBOM: ${{ inputs.generate_sbom }}
        ACCUKNOX_PROJECT_NAME: ${{ inputs.project_name }}
        KEEP_RESULTS: ${{ inputs.keep_results }}

      run: |
        set -euo pipefail
        
        # -------------------------
        # Validate required inputs
        # -------------------------
        if [ -z "${ACCUKNOX_TOKEN:-}" ] || \
           [ -z "${ACCUKNOX_LABEL:-}" ] || \
           [ -z "${ACCUKNOX_ENDPOINT:-}" ] || \
           [ -z "${IMAGE_NAME:-}" ]; then
          echo "ERROR: ACCUKNOX_TOKEN, ACCUKNOX_LABEL, ACCUKNOX_ENDPOINT, and IMAGE_NAME are required"
          exit 1
        fi
        
        TAG="${TAG:-latest}"
        SEVERITY="${SEVERITY:-UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL}"
        GENERATE_SBOM="${GENERATE_SBOM:-false}"
        SOFT_FAIL="${SOFT_FAIL:-false}"
        KEEP_RESULTS="${KEEP_RESULTS:-false}"
        
        # Normalize booleans
        SOFT_FAIL="${SOFT_FAIL,,}"
        GENERATE_SBOM="${GENERATE_SBOM,,}"
        KEEP_RESULTS="${KEEP_RESULTS,,}"
        
        # -------------------------
        # Download scanner
        # -------------------------
        curl -sL \
          https://github.com/accuknox/aspm-scanner-cli/releases/download/v0.14.0/accuknox-aspm-scanner \
          -o accuknox-aspm-scanner
        chmod +x accuknox-aspm-scanner
        
        ./accuknox-aspm-scanner tool install --type container
        
        # -------------------------
        # Vulnerability Scan (FIXED ORDER)
        # -------------------------
        echo "Running vulnerability scan..."
        
        ./accuknox-aspm-scanner scan container \
          --command "image ${IMAGE_NAME}:${TAG} --severity ${SEVERITY}" \
          --container-mode \
          $( [ "$SOFT_FAIL" = "true" ] && echo "--softfail" ) \
          $( [ "$KEEP_RESULTS" = "true" ] && echo "--keep-results" )
        
        mv results.json results-container.json
        
        # -------------------------
        # SBOM Scan (FIXED ORDER)
        # -------------------------
        if [ "$GENERATE_SBOM" = "true" ]; then
          if [ -z "${ACCUKNOX_PROJECT_NAME:-}" ]; then
            echo "ERROR: ACCUKNOX_PROJECT_NAME is required for SBOM"
            exit 1
          fi
        
          echo "Running SBOM scan..."
        
          ./accuknox-aspm-scanner scan container \
            --project-name "$ACCUKNOX_PROJECT_NAME" \
            --command "image ${IMAGE_NAME}:${TAG} --severity ${SEVERITY}" \
            --container-mode \
            --generate-sbom \
            $( [ "$SOFT_FAIL" = "true" ] && echo "--softfail" ) \
            $( [ "$KEEP_RESULTS" = "true" ] && echo "--keep-results" )
        
          mv results.json results-sbom.json
        fi
    - name: Upload AccuKnox Scan Results
      if: inputs.keep_results == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: accuknox-scan-results
        path: |
          results-container.json
          results-sbom.json
        retention-days: 15
